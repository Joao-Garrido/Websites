<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Juros Compostos + IPCA</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
  :root{
    --bg:#0b132b; --card:#1c2541; --muted:#3a506b; --acc:#5bc0be; --acc2:#ffd166; --text:#eaf4f4; --ok:#06d6a0; --warn:#ef476f;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#101936);}
  header{padding:28px 18px;text-align:center;color:var(--text)}
  header h1{margin:0 0 6px;font-size:28px;letter-spacing:.3px}
  header p{margin:0;opacity:.85}

  .wrap{max-width:1200px;margin:18px auto;padding:0 18px 40px;display:grid;grid-template-columns: 360px 1fr;gap:18px}
  @media (max-width:1024px){.wrap{grid-template-columns:1fr}}
  .card{background:var(--card);color:var(--text);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);border:1px solid #243055}
  .card h2{margin:0;padding:16px 16px 0;font-size:18px}
  .card .content{padding:16px}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-1{grid-template-columns:1fr}
  .grid-3{grid-template-columns:1fr 1fr 1fr}
  label{font-size:12px;opacity:.85}
  input, select{width:100%;margin-top:6px;padding:10px 12px;border-radius:10px;border:1px solid #2b375f;background:#121a32;color:var(--text);outline:none}
  input:focus{border-color:#4f78ff;box-shadow:0 0 0 3px rgba(79,120,255,.15)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:11px 14px;font-weight:700;letter-spacing:.2px;background:var(--acc);color:#072a2a}
  .btn.secondary{background:#223055;color:#cfe9ff;border:1px solid #2d3b66}
  .btn.warn{background:var(--warn);color:#FFF}
  .btn.ok{background:var(--ok);color:#052a22}
  .note{font-size:12px;opacity:.85}
  .chip{display:inline-flex;align-items:center;gap:8px;background:#0e1a36;border:1px solid #2c3b6c;color:#cfe4ff;border-radius:999px;padding:6px 10px;font-size:12px}
  .chip .x{cursor:pointer;color:#ff7a7a;font-weight:700}

  /* Summary */
  .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px}
  .kpi{background:#0f1934;border:1px solid #21305b;border-radius:12px;padding:12px}
  .kpi .label{font-size:12px;opacity:.7}
  .kpi .val{font-size:20px;font-weight:700;margin-top:6px}
  .kpi .sub{font-size:12px;opacity:.75;margin-top:4px}

  /* Chart */
  .chart-card{padding:10px 12px 18px}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .legend .sw{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}

  /* Table */
  .table-wrap{overflow:auto;max-height:420px;border-top:1px solid #223055}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:820px}
  thead th{position:sticky;top:0;background:#0e1832;border-bottom:1px solid #223055;padding:10px 8px;text-align:left;font-size:12px}
  tbody td{border-bottom:1px dashed #223055;padding:8px;text-align:right;font-variant-numeric:tabular-nums}
  tbody tr:nth-child(odd){background:#0c1731}
  tfoot td{position:sticky;bottom:0;background:#0e1832;border-top:1px solid #223055;padding:10px 8px;font-weight:700}
  .left{text-align:left}
  .right{text-align:right}

  .footer{max-width:1200px;margin:20px auto;color:#c9d6ff;opacity:.9;font-size:12px;padding:0 18px}
  a, a:visited{color:#9ad7ff}
</style>
</head>
<body>
  <header>
    <h1>Calculadora de Juros Compostos + IPCA</h1>
    <p>Aportes sobem no in√≠cio de cada ano pela <b>m√©dia IPCA (20 anos)</b>, juros compostos com taxa anual separada do IPCA. ‚ú®</p>
  </header>

  <div class="wrap">
    <!-- Painel de entradas -->
    <section class="card">
      <h2>Par√¢metros</h2>
      <div class="content">
        <div class="grid">
          <div>
            <label>Valor inicial (R$)
              <input type="number" id="valorInicial" value="10000" min="0" step="0.01" />
            </label>
          </div>
          <div>
            <label>Aporte mensal base (R$)
              <input type="number" id="aporteMensal" value="500" min="0" step="0.01" />
            </label>
          </div>
          <div>
            <label>Taxa de juros anual (% a.a.)
              <input type="number" id="jurosAnual" value="10" min="0" step="0.01" />
            </label>
          </div>
          <div>
            <label>Dura√ß√£o (anos)
              <input type="number" id="anos" value="20" min="1" step="1" />
            </label>
          </div>
        </div>

        <hr style="border-color:#223055;border-style:solid;border-width:1px;margin:16px 0;opacity:.6">

        <div class="grid">
          <div>
            <label>IPCA m√©dio (20 anos) ‚Äî geom√©trico (% a.a.)
              <input type="number" id="ipcaMedioInput" step="0.01" placeholder="Clique em Buscar IPCA" />
            </label>
            <div class="note">Se preferir, altere manualmente ap√≥s buscar.</div>
          </div>
          <div class="row" style="align-items:end">
            <button class="btn" id="btnBuscarIPCA">üîé Buscar IPCA (20 anos)</button>
            <button class="btn secondary" id="btnUsarPadrao" title="Define 5% a.a. como IPCA m√©dio">Usar 5% a.a.</button>
          </div>
        </div>
        <div class="note" id="ipcaFonte"></div>

        <hr style="border-color:#223055;border-style:solid;border-width:1px;margin:16px 0;opacity:.6">

        <h3 style="margin:0 0 8px;font-size:14px">Cortes (opcionais)</h3>
        <div class="note" style="margin-bottom:8px">
          Defina um <b>ano de corte</b> (ex.: 5 = in√≠cio do ano 5) para trocar a <i>taxa anual</i> e/ou o <i>aporte base</i>.
          O aporte continua crescendo pelos IPCA dos anos seguintes.
        </div>
        <div class="grid-3 grid" style="margin-bottom:8px">
          <div>
            <label>Ano do corte
              <input type="number" id="corteAno" min="1" step="1" placeholder="ex.: 5" />
            </label>
          </div>
          <div>
            <label>Nova taxa anual (% a.a.)
              <input type="number" id="corteTaxa" step="0.01" placeholder="opcional" />
            </label>
          </div>
          <div>
            <label>Novo aporte base (R$)
              <input type="number" id="corteAporte" step="0.01" placeholder="opcional" />
            </label>
          </div>
        </div>
        <div class="row">
          <button class="btn ok" id="btnAddCorte">+ Adicionar corte</button>
          <button class="btn secondary" id="btnLimparCortes">Limpar cortes</button>
        </div>
        <div class="row" id="cortesChips" style="margin-top:8px"></div>

        <hr style="border-color:#223055;border-style:solid;border-width:1px;margin:16px 0;opacity:.6">

        <div class="row">
          <button class="btn" id="btnCalcular">‚ñ∂Ô∏è Calcular simula√ß√£o</button>
          <button class="btn secondary" id="btnCSV">‚§ì Baixar CSV</button>
        </div>
      </div>
    </section>

    <!-- Resultados -->
    <section class="card chart-card">
      <div class="content">
        <h2>Resultados</h2>
        <div class="summary">
          <div class="kpi">
            <div class="label">Total investido</div>
            <div class="val" id="kpiInvestido">R$ 0,00</div>
            <div class="sub">Inicial + aportes</div>
          </div>
          <div class="kpi">
            <div class="label">Juros acumulados</div>
            <div class="val" id="kpiJuros">R$ 0,00</div>
            <div class="sub">Diferen√ßa para o saldo</div>
          </div>
          <div class="kpi">
            <div class="label">Saldo final</div>
            <div class="val" id="kpiSaldo">R$ 0,00</div>
            <div class="sub">Ao fim do per√≠odo</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <canvas id="chart" height="120"></canvas>
          <div class="legend">
            <span><span class="sw" style="background:var(--acc)"></span>Investido</span>
            <span><span class="sw" style="background:var(--acc2)"></span>Saldo (com juros)</span>
            <span><span class="sw" style="background:linear-gradient(90deg,#06d6a0,#40f1c9)"></span>Juros acumulados</span>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th class="left">M√™s</th>
              <th class="right">Saldo in√≠cio</th>
              <th class="right">Aporte do m√™s</th>
              <th class="right">Juros do m√™s</th>
              <th class="right">Saldo final</th>
              <th class="right">Aporte base do ano</th>
              <th class="right">Taxa anual vigente</th>
              <th class="right">Corte?</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td class="left">Totais</td>
              <td></td>
              <td id="ftAportes" class="right"></td>
              <td id="ftJuros" class="right"></td>
              <td id="ftSaldo" class="right"></td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </div>

  <div class="footer">
    <p>
      Fonte do IPCA (20 anos): s√©rie <b>SGS 433 - IPCA, varia√ß√£o mensal (%)</b>, via API p√∫blica do Banco Central do Brasil. A m√©dia usada aqui √© a
      <i>geom√©trica anualizada</i>, calculada sobre os √∫ltimos 240 meses dispon√≠veis. Veja notas abaixo.
    </p>
    <p class="note">
      Observa√ß√µes: dep√≥sitos mensais s√£o considerados no <b>in√≠cio de cada m√™s</b>; o aporte mensal √© atualizado no <b>in√≠cio de cada ano</b> pela m√©dia de IPCA; cortes aplicam-se no in√≠cio do ano indicado.
    </p>
  </div>

<script>
/** ==========================
 *  Utilidades de formata√ß√£o
 *  ========================== */
const fmtBRL = v => (v ?? 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtPct = v => `${(v*100).toFixed(2)}%`;
const toNumber = el => parseFloat(el.value.replace(',', '.')) || 0;

/** ==========================
 *  Estado / elementos
 *  ========================== */
const el = {
  valorInicial: document.querySelector('#valorInicial'),
  aporteMensal: document.querySelector('#aporteMensal'),
  jurosAnual: document.querySelector('#jurosAnual'),
  anos: document.querySelector('#anos'),
  ipcaMedioInput: document.querySelector('#ipcaMedioInput'),
  btnBuscarIPCA: document.querySelector('#btnBuscarIPCA'),
  btnUsarPadrao: document.querySelector('#btnUsarPadrao'),
  ipcaFonte: document.querySelector('#ipcaFonte'),
  // cortes
  corteAno: document.querySelector('#corteAno'),
  corteTaxa: document.querySelector('#corteTaxa'),
  corteAporte: document.querySelector('#corteAporte'),
  btnAddCorte: document.querySelector('#btnAddCorte'),
  btnLimparCortes: document.querySelector('#btnLimparCortes'),
  cortesChips: document.querySelector('#cortesChips'),
  // a√ß√µes
  btnCalcular: document.querySelector('#btnCalcular'),
  btnCSV: document.querySelector('#btnCSV'),
  // KPIs
  kpiInvestido: document.querySelector('#kpiInvestido'),
  kpiJuros: document.querySelector('#kpiJuros'),
  kpiSaldo: document.querySelector('#kpiSaldo'),
  // tabela
  tblBody: document.querySelector('#tbl tbody'),
  ftAportes: document.querySelector('#ftAportes'),
  ftJuros: document.querySelector('#ftJuros'),
  ftSaldo: document.querySelector('#ftSaldo'),
  // chart
  chartCanvas: document.querySelector('#chart')
};

let cortes = [];   // { ano: number, taxa?: number, aporte?: number }
let chart;

/** ==========================
 *  IPCA (SGS 433 - Bacen)
 *  ========================== */
async function buscarIPCAGeometrico20Anos() {
  // Endpoint: dados de toda a s√©rie; usaremos os √∫ltimos 240 meses.
  // Ex.: https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados?formato=json
  const url = 'https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados?formato=json';
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('Falha ao buscar IPCA no Bacen');
  const all = await res.json(); // [{data:'01/1980', valor:'x.xx'}, ...]
  if (!Array.isArray(all) || all.length < 240) throw new Error('S√©rie IPCA insuficiente');

  const last240 = all.slice(-240);
  const monthlyRates = last240.map(d => parseFloat(String(d.valor).replace(',', '.')) / 100); // p.ex. 0.0034
  // M√©dia geom√©trica anualizada:
  // produto dos (1 + taxa_mensal) ^ (12 / 240) - 1
  const product = monthlyRates.reduce((acc, r) => acc * (1 + r), 1);
  const annualized = Math.pow(product, 12 / monthlyRates.length) - 1;

  // datas de refer√™ncia
  const inicio = last240[0]?.data ?? '';
  const fim = last240[last240.length - 1]?.data ?? '';
  return { ipcaAnualGeometrico: annualized, inicio, fim };
}

/** ==========================
 *  Cortes (UI)
 *  ========================== */
function renderCortes() {
  el.cortesChips.innerHTML = '';
  if (!cortes.length) {
    const p = document.createElement('div');
    p.className = 'note';
    p.textContent = 'Nenhum corte adicionado.';
    el.cortesChips.appendChild(p);
    return;
  }
  cortes.sort((a,b)=>a.ano - b.ano);
  cortes.forEach((c, idx) => {
    const wrap = document.createElement('span');
    wrap.className = 'chip';
    const parts = [];
    parts.push(`Ano ${c.ano}`);
    if (typeof c.taxa === 'number') parts.push(`Juros ${c.taxa.toFixed(2)}%`);
    if (typeof c.aporte === 'number') parts.push(`Aporte ${fmtBRL(c.aporte)}`);
    wrap.innerHTML = parts.join(' ‚Ä¢ ') + ` <span class="x" title="remover" data-idx="${idx}">√ó</span>`;
    el.cortesChips.appendChild(wrap);
  });
  // remover
  el.cortesChips.querySelectorAll('.x').forEach(x=>{
    x.addEventListener('click', (e)=>{
      const i = Number(e.target.getAttribute('data-idx'));
      cortes.splice(i,1);
      renderCortes();
    });
  });
}

/** ==========================
 *  Simula√ß√£o mensal
 *  ========================== */
function simular() {
  const anos = Math.max(1, Math.floor(toNumber(el.anos)));
  const meses = anos * 12;

  let saldo = toNumber(el.valorInicial);
  let aporteBaseAno = toNumber(el.aporteMensal);
  let taxaAnualVigente = toNumber(el.jurosAnual) / 100;
  const ipcaMedio = (parseFloat(el.ipcaMedioInput.value.replace(',', '.')) || 0) / 100;

  // valida√ß√µes leves
  if (ipcaMedio <= -1) { alert('IPCA m√©dio inv√°lido.'); return; }

  // preparar cortes por ano para acesso r√°pido
  const cortesMap = new Map(); // ano -> {taxa?, aporte?}
  cortes.forEach(c => { if (c.ano >= 1 && c.ano <= anos) cortesMap.set(c.ano, c); });

  // datas humanizadas iniciando no ano corrente (mas s√≥ usamos r√≥tulos)
  const startDate = new Date();
  const labels = [];
  const rows = [];

  let investidoAportes = 0;
  const investidoSerie = []; // acumulado: inicial + aportes at√© o m√™s
  const saldoSerie = [];
  const jurosAcumSerie = [];

  // controle de in√≠cio de ano
  // m√™s 0..meses-1, anoAtual = Math.floor(m/12) + 1; m√™sNoAno = (m % 12) + 1
  for (let m = 0; m < meses; m++) {
    const anoAtual = Math.floor(m/12) + 1;
    const mesNoAno = (m % 12) + 1;

    // in√≠cio do ano: aplicar IPCA no aporte base e cortes (ordem: cortes sobrescrevem, depois segue IPCA s√≥ nos pr√≥ximos anos)
    if (mesNoAno === 1) {
      // aplicar corte antes: ele define a base para este ano
      if (cortesMap.has(anoAtual)) {
        const c = cortesMap.get(anoAtual);
        if (typeof c.aporte === 'number' && !Number.isNaN(c.aporte)) {
          aporteBaseAno = c.aporte;
        }
        if (typeof c.taxa === 'number' && !Number.isNaN(c.taxa)) {
          taxaAnualVigente = c.taxa / 100;
        }
      } else if (anoAtual > 1) {
        // sem corte: aporte base cresce pelo IPCA m√©dio no in√≠cio do ano (a partir do ano 2)
        aporteBaseAno = aporteBaseAno * (1 + ipcaMedio);
      }
    }

    // r√≥tulo do m√™s
    const d = new Date(startDate.getFullYear(), startDate.getMonth() + m, 1);
    const label = d.toLocaleDateString('pt-BR', { year:'numeric', month:'2-digit' });
    labels.push(label);

    const saldoInicio = saldo;

    // aporte no in√≠cio do m√™s
    const aporteMes = aporteBaseAno;
    saldo += aporteMes;
    investidoAportes += aporteMes;

    // juros do m√™s sobre o saldo ap√≥s o aporte
    const taxaMensal = Math.pow(1 + taxaAnualVigente, 1/12) - 1;
    const jurosMes = saldo * taxaMensal;
    saldo += jurosMes;

    // s√©ries para gr√°fico
    const totalInvestidoAteAqui = toNumber(el.valorInicial) + investidoAportes;
    investidoSerie.push(totalInvestidoAteAqui);
    saldoSerie.push(saldo);
    jurosAcumSerie.push(Math.max(0, saldo - totalInvestidoAteAqui));

    // linha para tabela
    rows.push({
      label, saldoInicio, aporteMes, jurosMes, saldoFim: saldo,
      aporteBaseAno, taxaAnualVigente, corteAqui: cortesMap.has(anoAtual) && mesNoAno===1 ? 'Sim' : ''
    });
  }

  // KPIs
  const totalInvestido = toNumber(el.valorInicial) + investidoAportes;
  const jurosAcum = Math.max(0, saldo - totalInvestido);

  el.kpiInvestido.textContent = fmtBRL(totalInvestido);
  el.kpiJuros.textContent = fmtBRL(jurosAcum);
  el.kpiSaldo.textContent = fmtBRL(saldo);

  // Tabela
  desenharTabela(rows, totalInvestido, jurosAcum, saldo);

  // Gr√°fico
  desenharGrafico(labels, investidoSerie, saldoSerie, jurosAcumSerie);
}

function desenharTabela(rows, totalInvestido, jurosAcum, saldoFinal){
  el.tblBody.innerHTML = '';
  const frag = document.createDocumentFragment();

  let somaAportes = 0, somaJuros = 0;

  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="left">${r.label}</td>
      <td>${fmtBRL(r.saldoInicio)}</td>
      <td>${fmtBRL(r.aporteMes)}</td>
      <td>${fmtBRL(r.jurosMes)}</td>
      <td>${fmtBRL(r.saldoFim)}</td>
      <td>${fmtBRL(r.aporteBaseAno)}</td>
      <td>${(r.taxaAnualVigente*100).toFixed(2)}%</td>
      <td>${r.corteAqui}</td>
    `;
    frag.appendChild(tr);
    somaAportes += r.aporteMes;
    somaJuros += r.jurosMes;
  });
  el.tblBody.appendChild(frag);
  el.ftAportes.textContent = fmtBRL(somaAportes);
  el.ftJuros.textContent = fmtBRL(somaJuros);
  el.ftSaldo.textContent = fmtBRL(saldoFinal);
}

function desenharGrafico(labels, investido, saldo, jurosAcum){
  // gradient helpers
  const ctx = el.chartCanvas.getContext('2d');
  const gradSaldo = ctx.createLinearGradient(0,0,0,200);
  gradSaldo.addColorStop(0, 'rgba(255,209,102,.45)');
  gradSaldo.addColorStop(1, 'rgba(255,209,102,0)');
  const gradJuros = ctx.createLinearGradient(0,0,0,200);
  gradJuros.addColorStop(0, 'rgba(6,214,160,.5)');
  gradJuros.addColorStop(1, 'rgba(6,214,160,0)');

  if (chart) chart.destroy();
  chart = new Chart(el.chartCanvas, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Investido',
          data: investido,
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--acc').trim(),
          backgroundColor: 'transparent',
          tension:.2,
          borderWidth:2
        },
        {
          label: 'Saldo (com juros)',
          data: saldo,
          borderColor: '#f1c40f',
          backgroundColor: gradSaldo,
          fill:true,
          tension:.25,
          borderWidth:2
        },
        {
          label: 'Juros acumulados',
          data: jurosAcum,
          borderColor: '#06d6a0',
          backgroundColor: gradJuros,
          fill:true,
          tension:.25,
          borderWidth:1.5
        }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{color:'#dbe7ff'}},
        tooltip:{
          callbacks:{
            label:(ctx)=> `${ctx.dataset.label}: ${fmtBRL(ctx.parsed.y)}`
          }
        }
      },
      scales:{
        x:{ticks:{color:'#cfe4ff'}, grid:{color:'rgba(255,255,255,.05)'}},
        y:{ticks:{color:'#cfe4ff', callback:(v)=>fmtBRL(v)}, grid:{color:'rgba(255,255,255,.05)'}}
      }
    }
  });
}

/** ==========================
 *  CSV
 *  ========================== */
function baixarCSV(){
  const rows = [['Mes','SaldoInicio','AporteMes','JurosMes','SaldoFim','AporteBaseAno','TaxaAnualVigente','Corte']];
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
    const cols = Array.from(tr.querySelectorAll('td')).map(td=>td.innerText.replace(/\./g,'').replace('R$ ','').replace(',','.'));
    rows.push(cols);
  });
  const csv = rows.map(r=>r.join(';')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'simulacao_juros_ipca.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

/** ==========================
 *  Eventos
 *  ========================== */
el.btnBuscarIPCA.addEventListener('click', async ()=>{
  try{
    el.btnBuscarIPCA.disabled = true; el.btnBuscarIPCA.textContent = 'Buscando...';
    const { ipcaAnualGeometrico, inicio, fim } = await buscarIPCAGeometrico20Anos();
    const pct = (ipcaAnualGeometrico*100);
    el.ipcaMedioInput.value = pct.toFixed(2);
    el.ipcaFonte.innerHTML = `IPCA m√©dio geom√©trico (20 anos): <b>${pct.toFixed(2)}% a.a.</b> ‚Ä¢ Per√≠odo: ${inicio} a ${fim}. Fonte: Bacen/SGS 433.`;
  }catch(e){
    console.error(e);
    alert('N√£o consegui buscar o IPCA agora. Voc√™ pode informar manualmente.');
  }finally{
    el.btnBuscarIPCA.disabled = false; el.btnBuscarIPCA.textContent = 'üîé Buscar IPCA (20 anos)';
  }
});

el.btnUsarPadrao.addEventListener('click', ()=>{
  el.ipcaMedioInput.value = '5.00';
  el.ipcaFonte.textContent = 'IPCA m√©dio definido manualmente como 5,00% a.a.';
});

el.btnAddCorte.addEventListener('click', ()=>{
  const ano = Math.max(1, Math.floor(toNumber(el.corteAno)));
  if (!ano) { alert('Informe o ano do corte (>=1)'); return; }
  const taxa = el.corteTaxa.value === '' ? undefined : parseFloat(el.corteTaxa.value.replace(',', '.'));
  const aporte = el.corteAporte.value === '' ? undefined : parseFloat(el.corteAporte.value.replace(',', '.'));
  if (taxa===undefined && aporte===undefined){ alert('Informe a nova taxa, o novo aporte ou ambos.'); return; }
  // se j√° existe, substitui
  const i = cortes.findIndex(c=>c.ano===ano);
  const novo = { ano, ...(taxa!==undefined?{taxa}:{}) , ...(aporte!==undefined?{aporte}:{}) };
  if (i>=0) cortes[i]=novo; else cortes.push(novo);
  renderCortes();
  el.corteAno.value=''; el.corteTaxa.value=''; el.corteAporte.value='';
});

el.btnLimparCortes.addEventListener('click', ()=>{ cortes = []; renderCortes(); });

el.btnCalcular.addEventListener('click', ()=> simular());
el.btnCSV.addEventListener('click', ()=> baixarCSV());

// inicial
renderCortes();
</script>
</body>
</html>
