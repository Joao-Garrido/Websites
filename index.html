<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Juros Compostos + IPCA ‚Äî PRO</title>

<!-- Chart.js + annotation plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>

<!-- Fonte e estilo -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  /* dark convidativo (da primeira vers√£o, com retoques) */
  --bg:#0b132b; --card:#141d3a; --muted:#8fa7cf;
  --line:#243055; --text:#eaf4ff;
  --acc:#26b6bd; --acc2:#ffd166; --ok:#06d6a0; --warn:#ef476f;
  --blue:#5ea0ff; --orange:#ff9f43; --green:#46d39a; --violet:#a38bff; --grey:#93a5c4;
}
*{box-sizing:border-box}
html,body{margin:0;background:linear-gradient(180deg,var(--bg),#0f1736);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
header{padding:26px 16px 10px;text-align:center}
h1{margin:0;font-size:28px;font-weight:800;letter-spacing:.2px}
.sub{opacity:.85;margin-top:6px}

.wrap{max-width:1250px;margin:0 auto;padding:0 16px 40px;display:grid;grid-template-columns:410px 1fr;gap:16px}
@media (max-width:1100px){.wrap{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 12px 36px rgba(0,0,0,.35)}
.card h2{margin:0;padding:14px 14px 0;font-size:16px}
.card .content{padding:14px}

.grid{display:grid;gap:10px}
.g2{grid-template-columns:1fr 1fr}
.g3{grid-template-columns:1fr 1fr 1fr}
.g1{grid-template-columns:1fr}
@media (max-width:600px){.g2,.g3{grid-template-columns:1fr}}

label{font-size:12px;color:var(--muted)}
input,select,textarea{
  width:100%;margin-top:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
  background:#0e1630;color:var(--text);outline:none;transition:.15s;
}
input:focus,select:focus,textarea:focus{border-color:#4f78ff;box-shadow:0 0 0 3px rgba(79,120,255,.2)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;background:var(--acc);color:#042f31}
.btn:hover{filter:brightness(.95)}
.btn.ghost{background:#0e1630;color:#cfe4ff;border:1px solid var(--line)}
.btn.alt{background:var(--ok);color:#062b20}
.btn.warn{background:var(--warn);color:#fff}
.small{font-size:12px;opacity:.9}
.hr{border:1px solid var(--line);border-bottom:0;margin:14px 0}

/* kpis */
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px}
.kpi{background:#0e1630;border:1px solid var(--line);border-radius:12px;padding:12px}
.kpi .l{font-size:12px;color:var(--muted)}
.kpi .v{font-size:20px;font-weight:800;margin-top:4px}
.kpi .s{font-size:12px;color:var(--muted);margin-top:2px}

/* instrumentos */
table.inst{width:100%;border-collapse:separate;border-spacing:0}
table.inst th, table.inst td{padding:6px 6px;border-bottom:1px dashed var(--line);font-size:12px;text-align:left}
table.inst thead th{position:sticky;top:0;background:#0e1630;border-bottom:1px solid var(--line)}
.del{cursor:pointer;color:#ff8d8d;font-weight:800}

/* chart */
.chart-box{padding:8px 12px}
canvas{width:100%;height:380px !important}
.legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:var(--muted);margin-top:6px}
.sw{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px}

/* tabela anual */
.table-wrap{overflow:auto;max-height:440px;border-top:1px solid var(--line)}
table.annual{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
table.annual thead th{position:sticky;top:0;background:#0e1630;border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:12px}
table.annual tbody td{border-bottom:1px dashed var(--line);padding:8px;text-align:right}
table.annual tbody tr:nth-child(odd){background:#0c1531}
.left{text-align:left}

.footer{max-width:1250px;margin:22px auto;color:var(--muted);font-size:12px;padding:0 16px}
</style>
</head>
<body>
<header>
  <h1>Calculadora de Juros Compostos + IPCA ‚Äî PRO</h1>
  <div class="sub">Aportes sobem no in√≠cio de cada ano pelo IPCA projetado. T√≠tulos com vencimento, IR conforme regra, reinvestimento opcional. Metas e linhas-guia no gr√°fico. ‚ú®</div>
</header>

<div class="wrap">
  <!-- Painel -->
  <section class="card">
    <h2>Par√¢metros</h2>
    <div class="content">
      <div class="grid g2">
        <div><label>Valor inicial (R$)
          <input type="number" id="valorInicial" value="10000" min="0" step="0.01"></label></div>
        <div><label>Aporte mensal base (R$)
          <input type="number" id="aporteMensal" value="800" min="0" step="0.01"></label></div>
        <div><label>Dura√ß√£o (anos)
          <input type="number" id="anos" value="20" min="1" step="1"></label></div>
        <div><label>Taxa de administra√ß√£o anual (%)
          <input type="number" id="taxaAdm" value="0.5" min="0" step="0.01"></label></div>
      </div>

      <div class="hr"></div>

      <h3 style="margin:4px 0 8px;font-size:14px">Infla√ß√£o (IPCA)</h3>
      <div class="grid g1">
        <div class="row" style="justify-content:space-between">
          <label style="flex:1">IPCA m√©dio (20 anos) ‚Äî geom√©trico (% a.a.)
            <input type="number" id="ipcaMedioInput" placeholder="Clique em Buscar IPCA" step="0.01">
          </label>
          <button class="btn" id="btnBuscarIPCA" title="Bacen/SGS 433">üîé Buscar IPCA</button>
          <button class="btn ghost" id="btnUsar5">Usar 5% a.a.</button>
        </div>
        <div id="ipcaFonte" class="small"></div>
        <div class="grid g2">
          <div>
            <label>Modelo de proje√ß√£o</label>
            <select id="projModelo">
              <option value="const">Constante (usa IPCA m√©dio)</option>
              <option value="reversao">Revers√£o √† meta</option>
              <option value="custom">Personalizada (por ano)</option>
            </select>
          </div>
          <div class="row" id="boxReversao" style="display:none">
            <label style="flex:1">Meta IPCA (% a.a.)<input type="number" id="projMeta" value="3" step="0.1"></label>
            <label style="flex:1">Horizonte (anos)<input type="number" id="projHorizonte" value="5" min="1" step="1"></label>
          </div>
        </div>
        <div id="boxCustom" style="display:none">
          <label>IPCA por ano (% a.a.; vazio = proje√ß√£o padr√£o)</label>
          <textarea id="projLista" rows="3" placeholder="Ex.: 5;4.8;4.5;4.2;4;3.8"></textarea>
          <div class="small">Valores aplicam-se a partir do Ano 2.</div>
        </div>
      </div>

      <div class="hr"></div>

      <h3 style="margin:4px 0 8px;font-size:14px">Cortes (opcionais)</h3>
      <div class="grid g3">
        <div><label>Ano do corte
          <input type="number" id="corteAno" min="1" step="1" placeholder="ex.: 5"></label></div>
        <div><label>Novo aporte base (R$)
          <input type="number" id="corteAporte" step="0.01" placeholder="opcional"></label></div>
        <div><label>(Opcional) Nota<br>
          <input type="text" id="corteNota" placeholder="ex.: b√¥nus, promo√ß√£o etc."></label></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn alt" id="btnAddCorte">+ Adicionar corte</button>
        <button class="btn ghost" id="btnLimparCortes">Limpar cortes</button>
      </div>
      <div class="row" id="cortesChips" style="margin-top:8px"></div>

      <div class="hr"></div>

      <h3 style="margin:4px 0 8px;font-size:14px">Metas de patrim√¥nio (linhas-guia)</h3>
      <div class="grid g2">
        <div><label>Ano da meta
          <input type="number" id="metaAno" min="1" step="1" placeholder="ex.: 10"></label></div>
        <div><label>Valor alvo (R$)
          <input type="number" id="metaValor" step="0.01" placeholder="ex.: 500000"></label></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn alt" id="btnAddMeta">+ Adicionar meta</button>
        <button class="btn ghost" id="btnLimparMetas">Limpar metas</button>
      </div>
      <div class="row" id="metasChips" style="margin-top:8px"></div>

      <div class="hr"></div>

      <h3 style="margin:4px 0 8px;font-size:14px">T√≠tulos (CDB, LCI, LCA)</h3>
      <div class="small" style="margin-bottom:6px">Aloca√ß√£o √© aplicada sobre cada aporte mensal. No vencimento, juros do CDB t√™m IR regressivo (<=180d 22,5%; 181‚Äì360d 20%; 361‚Äì720d 17,5%; >720d 15%). LCI/LCA s√£o isentos.</div>
      <table class="inst" id="instTable">
        <thead>
          <tr><th>Tipo</th><th>Taxa (% a.a.)</th><th>Vencimento (anos)</th><th>Aloca√ß√£o (%)</th><th>Reinvestir?</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:6px">
        <button class="btn alt" id="btnAddInst">+ Adicionar t√≠tulo</button>
        <button class="btn ghost" id="btnExemplo">Exemplo (CDB 100%)</button>
      </div>
      <div class="small" id="alocMsg"></div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="btnCalcular">‚ñ∂Ô∏è Calcular</button>
        <button class="btn ghost" id="btnCSV">‚§ì CSV</button>
        <button class="btn ghost" id="btnPNG">‚§ì PNG</button>
      </div>
    </div>
  </section>

  <!-- Resultados -->
  <section class="card">
    <div class="content">
      <h2>Resultados</h2>
      <div class="kpis">
        <div class="kpi"><div class="l">Total investido</div><div class="v" id="kpiInvestido">R$ 0,00</div><div class="s">Inicial + aportes</div></div>
        <div class="kpi"><div class="l">Juros l√≠quidos</div><div class="v" id="kpiJuros">R$ 0,00</div><div class="s">Ap√≥s IR e taxa adm</div></div>
        <div class="kpi"><div class="l">Saldo final (nominal)</div><div class="v" id="kpiSaldo">R$ 0,00</div><div class="s">Ao fim do per√≠odo</div></div>
      </div>

      <div class="chart-box">
        <canvas id="chart"></canvas>
        <div class="legend">
          <span><span class="sw" style="background:var(--blue)"></span>Investido</span>
          <span><span class="sw" style="background:var(--orange)"></span>Saldo (nominal)</span>
          <span><span class="sw" style="background:var(--green)"></span>Saldo (R$ de hoje)</span>
          <span><span class="sw" style="background:var(--violet)"></span>Poder de compra (√≠ndice)</span>
          <span><span class="sw" style="background:var(--acc2)"></span>Metas / Cortes</span>
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <table class="annual" id="tbl">
        <thead>
          <tr>
            <th class="left">Ano</th>
            <th>Saldo in√≠cio</th>
            <th>Aporte do ano</th>
            <th>Juros do ano (l√≠q.)</th>
            <th>IR pago</th>
            <th>Taxa Adm</th>
            <th>Saldo final</th>
            <th>Saldo (R$ de hoje)</th>
            <th>Aporte base do ano</th>
            <th>IPCA do ano</th>
            <th>Corte?</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<div class="footer">
  <p>Bot√£o ‚ÄúBuscar IPCA‚Äù usa <b>SGS 433 (IPCA mensal %)</b> da API p√∫blica do Bacen. M√©dia usada: <i>geom√©trica anualizada</i> dos √∫ltimos 240 meses. Aporte √© reajustado no in√≠cio de cada ano. CDB: IR regressivo no vencimento; LCI/LCA: isentos (pessoa f√≠sica). Esta √© uma simula√ß√£o educacional.</p>
</div>

<script>
/* ======= Utils ======= */
const brl = v => (v??0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const toNum = el => parseFloat(String(el.value).replace(',','.'))||0;

/* ======= Elements ======= */
const E = {
  valorInicial: q('#valorInicial'),
  aporteMensal: q('#aporteMensal'),
  anos: q('#anos'),
  taxaAdm: q('#taxaAdm'),
  ipcaMedioInput: q('#ipcaMedioInput'),
  btnBuscarIPCA: q('#btnBuscarIPCA'),
  btnUsar5: q('#btnUsar5'),
  ipcaFonte: q('#ipcaFonte'),
  projModelo: q('#projModelo'),
  projMeta: q('#projMeta'),
  projHorizonte: q('#projHorizonte'),
  projLista: q('#projLista'),
  boxReversao: q('#boxReversao'),
  boxCustom: q('#boxCustom'),
  // cortes
  corteAno: q('#corteAno'),
  corteAporte: q('#corteAporte'),
  corteNota: q('#corteNota'),
  btnAddCorte: q('#btnAddCorte'),
  btnLimparCortes: q('#btnLimparCortes'),
  cortesChips: q('#cortesChips'),
  // metas
  metaAno: q('#metaAno'),
  metaValor: q('#metaValor'),
  btnAddMeta: q('#btnAddMeta'),
  btnLimparMetas: q('#btnLimparMetas'),
  metasChips: q('#metasChips'),
  // inst
  instTable: q('#instTable tbody'),
  btnAddInst: q('#btnAddInst'),
  btnExemplo: q('#btnExemplo'),
  alocMsg: q('#alocMsg'),
  // actions
  btnCalcular: q('#btnCalcular'),
  btnCSV: q('#btnCSV'),
  btnPNG: q('#btnPNG'),
  // KPIs
  kpiInvestido: q('#kpiInvestido'),
  kpiJuros: q('#kpiJuros'),
  kpiSaldo: q('#kpiSaldo'),
  // chart & table
  chartEl: q('#chart'),
  tblBody: q('#tbl tbody'),
};
function q(s){return document.querySelector(s)}

/* ======= State ======= */
let cortes = []; // {ano, novoAporte?, nota?}
let metas = [];  // {ano, valor}
let instId = 0;  // incremental
let chart;

/* ======= IPCA (SGS 433 Bacen) ======= */
async function buscarIPCAGeometrico20Anos(){
  const url='https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados?formato=json';
  const r = await fetch(url,{cache:'no-store'});
  if(!r.ok) throw new Error('Falha ao buscar IPCA');
  const all = await r.json();
  if(!Array.isArray(all) || all.length<240) throw new Error('S√©rie insuficiente');
  const last240 = all.slice(-240);
  const monthly = last240.map(d => parseFloat(String(d.valor).replace(',','.'))/100);
  const product = monthly.reduce((a,x)=>a*(1+x),1);
  const annual = Math.pow(product,12/monthly.length)-1;
  return {annual, inicio:last240[0]?.data, fim:last240.at(-1)?.data};
}

/* ======= Proje√ß√£o de IPCA por ano ======= */
function montarIPCAAnual(anos, ipcaMedio){
  const modelo = E.projModelo.value;
  const out = new Array(anos).fill(ipcaMedio);
  if(modelo==='reversao'){
    const meta = Math.max(-0.99, toNum(E.projMeta)/100);
    const H = Math.max(1, Math.floor(toNum(E.projHorizonte)));
    for(let a=2;a<=anos;a++){
      const t = Math.min(1,(a-2)/(H-1||1));
      out[a-1] = ipcaMedio*(1-t) + meta*t;
    }
  }else if(modelo==='custom'){
    const raw = E.projLista.value.split(';').map(s=>parseFloat(s.replace(',','.'))/100).filter(x=>!Number.isNaN(x));
    for(let i=0;i<raw.length && (i+1)<anos;i++) out[i+1]=raw[i];
  }
  return out; // out[a-1] = IPCA do ano a
}

/* ======= Instrumentos UI ======= */
function addInstRow(data){
  const tr = document.createElement('tr');
  const id = ++instId;
  tr.dataset.id = id;
  tr.innerHTML = `
    <td>
      <select class="tipo">
        <option value="CDB"${data?.tipo==='CDB'?' selected':''}>CDB</option>
        <option value="LCI"${data?.tipo==='LCI'?' selected':''}>LCI</option>
        <option value="LCA"${data?.tipo==='LCA'?' selected':''}>LCA</option>
      </select>
    </td>
    <td><input type="number" class="taxa" step="0.01" value="${data?.taxa ?? 12}"></td>
    <td><input type="number" class="vcto" step="0.1" value="${data?.vcto ?? 2}"></td>
    <td><input type="number" class="aloc" step="0.01" value="${data?.aloc ?? 100}"></td>
    <td style="text-align:center"><input type="checkbox" class="reinv"${(data?.reinv ?? true)?' checked':''}></td>
    <td><span class="del" title="remover">√ó</span></td>
  `;
  tr.querySelector('.del').addEventListener('click',()=>{ tr.remove(); validarAlocacao(); });
  ['input','change'].forEach(evt => tr.addEventListener(evt, validarAlocacao));
  E.instTable.appendChild(tr);
  validarAlocacao();
}
function readInstRows(){
  const rows = Array.from(E.instTable.querySelectorAll('tr'));
  return rows.map(tr=>{
    const tipo = tr.querySelector('.tipo').value;
    const taxa = parseFloat(tr.querySelector('.taxa').value)||0;
    const vcto = parseFloat(tr.querySelector('.vcto').value)||1;
    const aloc = parseFloat(tr.querySelector('.aloc').value)||0;
    const reinv = tr.querySelector('.reinv').checked;
    return {tipo, taxa, vcto, aloc, reinv};
  });
}
function validarAlocacao(){
  const inst = readInstRows();
  const total = inst.reduce((s,i)=>s+(i.aloc||0),0);
  let msg = `Aloca√ß√£o total: ${total.toFixed(2)}%`;
  if(total>100) msg += ' ‚Ä¢ ‚ö†Ô∏è acima de 100% ‚Äî ajuste!';
  if(total<100) msg += ' ‚Ä¢ restante vai para ‚ÄúCaixa‚Äù (rendendo 0% nominal).';
  E.alocMsg.textContent = msg;
}

/* ======= Cortes / Metas UI ======= */
function renderChips(container, list, labelFn, onDel){
  container.innerHTML='';
  if(!list.length){
    const p=document.createElement('div'); p.className='small'; p.textContent='Nenhum item.'; container.appendChild(p); return;
  }
  list.forEach((x,i)=>{
    const span = document.createElement('span');
    span.className='small';
    span.style.cssText='display:inline-flex;gap:8px;align-items:center;background:#0e1630;border:1px dashed var(--line);padding:6px 10px;border-radius:999px;margin-right:6px;margin-bottom:6px';
    span.innerHTML = `${labelFn(x)} <span class="del" data-i="${i}">√ó</span>`;
    container.appendChild(span);
  });
  container.querySelectorAll('.del').forEach(d=>{
    d.addEventListener('click', e=>{ const i=Number(e.target.dataset.i); onDel(i); });
  });
}

function renderCortes(){ renderChips(E.cortesChips, cortes, c => `Ano ${c.ano} ‚Ä¢ Aporte ${c.novoAporte?brl(c.novoAporte):'‚Äî'}${c.nota?` ‚Ä¢ ${c.nota}`:''}`, i => { cortes.splice(i,1); renderCortes(); }); }
function renderMetas(){ renderChips(E.metasChips, metas, m => `Meta ano ${m.ano}: ${brl(m.valor)}`, i => { metas.splice(i,1); renderMetas(); }); }

/* ======= IR Regressivo (CDB) ======= */
function irCdbAliquota(prazoMeses){
  if(prazoMeses<=6*30/30){} // noop, tabela √© por dias, usaremos meses equivalentes
  const d = prazoMeses*30; // aproximando 30d/m√™s
  if(d<=180) return 0.225;
  if(d<=360) return 0.20;
  if(d<=720) return 0.175;
  return 0.15;
}

/* ======= Simula√ß√£o ======= */
function simular(){
  const anos = Math.max(1, Math.floor(toNum(E.anos)));
  const meses = anos*12;
  const aporteMensalBaseIni = toNum(E.aporteMensal);
  const taxaAdmAnual = Math.max(0, toNum(E.taxaAdm)/100);
  const taxaAdmMensal = taxaAdmAnual/12; // aprox. linear

  const ipcaMedio = (parseFloat(E.ipcaMedioInput.value?.replace(',','.'))||0)/100;
  const ipcaPorAno = montarIPCAAnual(anos, ipcaMedio);

  const inst = readInstRows();
  const alocTotal = inst.reduce((s,i)=>s+(i.aloc||0),0);
  const alocFrac = inst.map(i=>({...i, frac:(i.aloc||0)/100}));
  const caixaFrac = Math.max(0, 1 - alocTotal/100); // rende 0% nominal (caixa inerte)

  let saldoCaixa = 0; // sem IR
  let saldo = toNum(E.valorInicial);
  let investidoAportes = 0;

  // Lotes por instrumento (com vencimento)
  const lotes = []; // {tipo, principal, principalIni, mesesRest, taxaAnual, prazoMeses, reinv}

  // se valor inicial: joga para caixa (simples) ‚Äî poderia distribuir, mas manteremos claro
  saldoCaixa += toNum(E.valorInicial);

  // agregadores anuais
  const rowsAno=[]; const xLabels=[];
  const serieInvestido=[]; const serieSaldoNominal=[]; const serieSaldoReal=[]; const seriePoderCompraIdx=[];
  let jurosAno=0, irAno=0, admAno=0;
  let aporteBaseAno = aporteMensalBaseIni;

  // helper para aplicar taxa adm proporcional nos lotes + caixa
  function aplicarTaxaAdm(){
    // reduzir proporcionalmente: aplicar em caixa e todos os lotes
    const totalAntes = saldoCaixa + lotes.reduce((s,l)=>s+l.principal,0);
    if(totalAntes<=0 || taxaAdmMensal<=0) return 0;
    const custo = totalAntes * taxaAdmMensal;
    const fator = 1 - taxaAdmMensal;
    saldoCaixa *= fator;
    lotes.forEach(l=>{ l.principal *= fator; });
    return custo;
  }

  for(let m=0;m<meses;m++){
    const anoAtual = Math.floor(m/12)+1;
    const mesNoAno = (m%12)+1;

    // In√≠cio do ano: reajuste por IPCA do ano anterior + cortes
    if(mesNoAno===1){
      // corte primeiro
      const corte = cortes.find(c=>c.ano===anoAtual);
      if(corte && typeof corte.novoAporte==='number') aporteBaseAno = corte.novoAporte;
      else if(anoAtual>1) aporteBaseAno = aporteBaseAno * (1 + ipcaPorAno[anoAtual-2]);
      // iniciar agregadores do ano
      if(!rowsAno[anoAtual-1]) rowsAno[anoAtual-1] = {ano:anoAtual, saldoInicio: saldoCaixa + lotes.reduce((s,l)=>s+l.principal,0), aporteAno:0, jurosAno:0, irAno:0, admAno:0, saldoFim:null, aporteBaseAno, ipcaAno: ipcaPorAno[anoAtual-1], corte: corte? (corte.nota?('Sim ‚Äî '+corte.nota):'Sim') : ''};
    }

    // Dep√≥sito do m√™s (no in√≠cio)
    const aporteMes = aporteBaseAno;
    investidoAportes += aporteMes;
    rowsAno[anoAtual-1].aporteAno += aporteMes;

    // dividir aporte entre instrumentos e caixa
    const paraCaixa = aporteMes * caixaFrac;
    saldoCaixa += paraCaixa;
    alocFrac.forEach(i=>{
      const v = aporteMes * i.frac;
      if(v<=0) return;
      const prazoMeses = Math.max(1, Math.round(i.vcto*12));
      lotes.push({
        tipo:i.tipo,
        principal:v,
        principalIni:v,
        mesesRest:prazoMeses,
        taxaAnual:(i.taxa||0)/100,
        prazoMeses:prazoMeses,
        reinv: !!i.reinv
      });
    });

    // Render nos lotes
    lotes.forEach(l=>{
      const rMensal = Math.pow(1+l.taxaAnual,1/12)-1;
      const j = l.principal * rMensal;
      l.principal += j;
      jurosAno += j;
      l.mesesRest -= 1;
    });

    // Maturidade: aplicar IR (se CDB), reinvestir ou mandar p/ caixa
    for(let i=lotes.length-1;i>=0;i--){
      const l = lotes[i];
      if(l.mesesRest<=0){
        const ganho = Math.max(0, l.principal - l.principalIni);
        let ir=0;
        if(l.tipo==='CDB'){
          const aliq = irCdbAliquota(l.prazoMeses);
          ir = ganho * aliq;
        }
        irAno += ir;
        const liquido = l.principal - ir;
        if(l.reinv){
          // reinicia lote
          l.principal = liquido;
          l.principalIni = liquido;
          l.mesesRest = l.prazoMeses;
        }else{
          saldoCaixa += liquido;
          lotes.splice(i,1);
        }
      }
    }

    // Caixa rende 0% nominal (pode-se estender para taxa da caixa se desejar)

    // Taxa de administra√ß√£o mensal (sobre total)
    const custoAdm = aplicarTaxaAdm();
    admAno += custoAdm;

    // Fim do ano -> registrar s√©ries
    if(mesNoAno===12){
      const total = saldoCaixa + lotes.reduce((s,l)=>s+l.principal,0);
      rowsAno[anoAtual-1].jurosAno += jurosAno - irAno - admAno;
      rowsAno[anoAtual-1].irAno += irAno;
      rowsAno[anoAtual-1].admAno += admAno;
      rowsAno[anoAtual-1].saldoFim = total;

      // s√©ries p/ gr√°fico
      xLabels.push(`Ano ${anoAtual}`);
      const investidoAteAqui = toNum(E.valorInicial) + investidoAportes;
      serieInvestido.push(investidoAteAqui);
      serieSaldoNominal.push(total);

      // poder de compra: deflator acumulado at√© este ano
      const infl = ipcaPorAno.slice(0, anoAtual).reduce((acc,x)=>acc*(1+x),1);
      const saldoReal = total / infl;
      serieSaldoReal.push(saldoReal);

      const idxPoderCompra = (toNum(E.valorInicial)) / infl; // √≠ndice baseado no saldo inicial
      seriePoderCompraIdx.push(idxPoderCompra);

      // reset contadores anuais
      saldo = total;
      jurosAno=0; irAno=0; admAno=0;
    }
  }

  // KPIs
  const investidoTotal = toNum(E.valorInicial) + investidoAportes;
  const saldoFinal = serieSaldoNominal.at(-1) || 0;
  const jurosLiquidos = Math.max(0, saldoFinal - investidoTotal);
  E.kpiInvestido.textContent = brl(investidoTotal);
  E.kpiSaldo.textContent = brl(saldoFinal);
  E.kpiJuros.textContent = brl(jurosLiquidos);

  // Tabela
  renderTabela(rowsAno, serieSaldoReal);

  // Gr√°fico
  renderGrafico(xLabels, serieInvestido, serieSaldoNominal, serieSaldoReal, seriePoderCompraIdx, rowsAno);
}

/* ======= Tabela anual ======= */
function renderTabela(rows, serieSaldoReal){
  E.tblBody.innerHTML='';
  const frag=document.createDocumentFragment();
  rows.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="left">${r.ano}</td>
      <td>${brl(r.saldoInicio)}</td>
      <td>${brl(r.aporteAno)}</td>
      <td>${brl(r.jurosAno)}</td>
      <td>${brl(r.irAno)}</td>
      <td>${brl(r.admAno)}</td>
      <td>${brl(r.saldoFim)}</td>
      <td>${brl(serieSaldoReal[idx]||0)}</td>
      <td>${brl(r.aporteBaseAno)}</td>
      <td>${((r.ipcaAno||0)*100).toFixed(2)}%</td>
      <td>${r.corte||''}</td>
    `;
    frag.appendChild(tr);
  });
  E.tblBody.appendChild(frag);
}

/* ======= Gr√°fico ======= */
function renderGrafico(labels, investido, saldoNom, saldoReal, poderCompraIdx, rows){
  if(chart) chart.destroy();
  const annotations = {};

  // Cortes: linhas verticais
  rows.forEach((r,idx)=>{
    if(r.corte){
      annotations['corte_'+idx] = {
        type:'line', xMin: idx, xMax: idx,
        borderColor: '#ffd166', borderWidth: 2, borderDash:[6,6],
        label:{enabled:true, content:`Corte ${r.ano}`, position:'start', backgroundColor:'#0e1630', color:'#ffd166'}
      };
    }
  });

  // Metas: linhas horizontais
  metas.forEach((m,i)=>{
    annotations['meta_'+i] = {
      type:'line', yMin: m.valor, yMax: m.valor,
      borderColor: '#26b6bd', borderWidth: 2,
      label:{enabled:true, content:`Meta ${m.ano}: ${brl(m.valor)}`, position:'end', backgroundColor:'#0e1630', color:'#26b6bd'}
    };
  });

  // Registrar plugin
  Chart.register(window['chartjs-plugin-annotation']);

  chart = new Chart(E.chartEl, {
    type:'line',
    data:{
      labels,
      datasets:[
        {
          label:'Investido',
          data:investido,
          borderColor:'var(--blue)',
          backgroundColor:'transparent',
          tension:.25, borderWidth:2, fill:false
        },
        {
          label:'Saldo (nominal)',
          data:saldoNom,
          borderColor:'var(--orange)',
          backgroundColor:'transparent',
          tension:.22, borderWidth:2, fill:false
        },
        {
          label:'Saldo (R$ de hoje)',
          data:saldoReal,
          borderColor:'var(--green)',
          backgroundColor:'transparent',
          tension:.22, borderWidth:2, fill:false
        },
        {
          label:'Poder de compra (√≠ndice)',
          data:poderCompraIdx,
          borderColor:'var(--violet)',
          backgroundColor:'transparent',
          tension:.22, borderWidth:2, fill:false, borderDash:[4,4]
        }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      scales:{
        y:{beginAtZero:true, ticks:{color:'#cfe4ff', callback:v=>brl(v)}, grid:{color:'rgba(255,255,255,.06)'}},
        x:{ticks:{color:'#cfe4ff'}, grid:{color:'rgba(255,255,255,.05)'}}
      },
      plugins:{
        legend:{labels:{color:'#dbe7ff', boxWidth:12}},
        tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${brl(ctx.parsed.y)}`}},
        annotation:{annotations}
      }
    }
  });
}

/* ======= CSV & PNG ======= */
function baixarCSV(){
  const rows=[['Ano','SaldoInicio','AporteAno','JurosAnoLiquido','IR','TaxaAdm','SaldoFinal','SaldoReal','AporteBaseAno','IPCAAno','Corte']];
  E.tblBody.querySelectorAll('tr').forEach(tr=>{
    const cols=Array.from(tr.children).map(td=>td.innerText.replace(/\./g,'').replace('R$ ','').replace(',','.'));
    rows.push(cols);
  });
  const csv=rows.map(r=>r.join(';')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='simulacao_anual.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function baixarPNG(){
  const a=document.createElement('a');
  a.href=E.chartEl.toDataURL('image/png',1.0);
  a.download='grafico.png'; a.click();
}

/* ======= Eventos ======= */
E.btnBuscarIPCA.addEventListener('click', async ()=>{
  try{
    E.btnBuscarIPCA.disabled=true; E.btnBuscarIPCA.textContent='Buscando...';
    const {annual,inicio,fim}=await buscarIPCAGeometrico20Anos();
    E.ipcaMedioInput.value=(annual*100).toFixed(2);
    E.ipcaFonte.innerHTML=`IPCA m√©dio (geom., 20 anos): <b>${(annual*100).toFixed(2)}% a.a.</b> ‚Ä¢ Per√≠odo ${inicio}‚Äì${fim}`;
  }catch(e){ alert('N√£o consegui buscar o IPCA agora. Insira manualmente.'); }
  finally{ E.btnBuscarIPCA.disabled=false; E.btnBuscarIPCA.textContent='üîé Buscar IPCA'; }
});
E.btnUsar5.addEventListener('click',()=>{ E.ipcaMedioInput.value='5.00'; E.ipcaFonte.textContent='IPCA m√©dio definido manualmente: 5,00% a.a.'; });

E.projModelo.addEventListener('change', ()=>{
  const v=E.projModelo.value;
  E.boxReversao.style.display = v==='reversao' ? 'flex' : 'none';
  E.boxCustom.style.display   = v==='custom'   ? 'block' : 'none';
});

E.btnAddCorte.addEventListener('click',()=>{
  const ano = Math.max(1, Math.floor(toNum(E.corteAno)));
  if(!ano){ alert('Informe o ano do corte (>=1)'); return; }
  const novoAporte = E.corteAporte.value==='' ? undefined : parseFloat(E.corteAporte.value.replace(',','.'));
  const nota = E.corteNota.value?.trim() || '';
  const i = cortes.findIndex(c=>c.ano===ano);
  const novo = {ano, ...(novoAporte!==undefined?{novoAporte}:{}) , ...(nota?{nota}:{})};
  if(i>=0) cortes[i]=novo; else cortes.push(novo);
  E.corteAno.value=''; E.corteAporte.value=''; E.corteNota.value='';
  renderCortes();
});
E.btnLimparCortes.addEventListener('click',()=>{ cortes=[]; renderCortes(); });

E.btnAddMeta.addEventListener('click',()=>{
  const ano = Math.max(1, Math.floor(toNum(E.metaAno)));
  const valor = parseFloat(E.metaValor.value?.replace(',','.'));
  if(!ano || Number.isNaN(valor)){ alert('Informe ano e valor da meta.'); return; }
  metas.push({ano, valor});
  metas.sort((a,b)=>a.valor-b.valor);
  E.metaAno.value=''; E.metaValor.value=''; renderMetas();
});
E.btnLimparMetas.addEventListener('click',()=>{ metas=[]; renderMetas(); });

E.btnAddInst.addEventListener('click',()=> addInstRow({tipo:'CDB', taxa:12, vcto:2, aloc:50, reinv:true}));
E.btnExemplo.addEventListener('click',()=>{
  E.instTable.innerHTML='';
  addInstRow({tipo:'CDB', taxa:12, vcto:2, aloc:100, reinv:true});
});
E.btnCalcular.addEventListener('click',()=> simular());
E.btnCSV.addEventListener('click',()=> baixarCSV());
E.btnPNG.addEventListener('click',()=> baixarPNG());

/* ======= Inicial ======= */
addInstRow({tipo:'CDB', taxa:12, vcto:2, aloc:100, reinv:true});
renderCortes(); renderMetas();
simular();
</script>
</body>
</html>
