<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Renda Fixa PRO ‚Äî Cat√°logo + Simulador</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>

<style>
:root{
  --bg:#0b132b; --card:#141d3a; --muted:#8fa7cf; --line:#243055; --text:#eaf4ff;
  --acc:#26b6bd; --acc2:#ffd166; --ok:#06d6a0; --warn:#ef476f;
  --blue:#5ea0ff; --orange:#ff9f43; --green:#46d39a; --violet:#a38bff; --grey:#93a5c4;
}
*{box-sizing:border-box}
html,body{margin:0;background:linear-gradient(180deg,var(--bg),#0f1736);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
header{padding:26px 16px 10px;text-align:center}
h1{margin:0;font-size:28px;font-weight:800;letter-spacing:.2px}
.sub{opacity:.85;margin-top:6px}

.wrap{max-width:1320px;margin:0 auto;padding:0 16px 40px;display:grid;grid-template-columns:440px 1fr;gap:16px}
@media (max-width:1180px){.wrap{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 12px 36px rgba(0,0,0,.35)}
.card h2{margin:0;padding:14px 14px 0;font-size:16px}
.card .content{padding:14px}
.hr{border:1px solid var(--line);border-bottom:0;margin:14px 0}
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;margin-top:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0e1630;color:var(--text);outline:none}
input:focus,select:focus,textarea:focus{border-color:#4f78ff;box-shadow:0 0 0 3px rgba(79,120,255,.2)}
.grid{display:grid;gap:10px}
.g1{grid-template-columns:1fr}
.g2{grid-template-columns:1fr 1fr}
.g3{grid-template-columns:1fr 1fr 1fr}
@media (max-width:600px){.g2,.g3{grid-template-columns:1fr}}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;background:var(--acc);color:#042f31}
.btn:hover{filter:brightness(.95)}
.btn.ghost{background:#0e1630;color:#cfe4ff;border:1px solid var(--line)}
.btn.alt{background:var(--ok);color:#062b20}
.btn.warn{background:var(--warn);color:#fff}
.small{font-size:12px;opacity:.9}

/* Cat√°logo */
.search{display:flex;gap:8px;align-items:center}
.cat-list{max-height:220px;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:6px;background:#0e1630}
.cat-item{padding:8px;border-bottom:1px dashed var(--line);cursor:pointer}
.cat-item:last-child{border-bottom:0}
.cat-item:hover{background:#0f1a36}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:11px;margin-left:6px}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px}
.kpi{background:#0e1630;border:1px solid var(--line);border-radius:12px;padding:12px}
.kpi .l{font-size:12px;color:var(--muted)}
.kpi .v{font-size:20px;font-weight:800;margin-top:4px}
.kpi .s{font-size:12px;color:var(--muted);margin-top:2px}

/* Instrumentos */
table.inst{width:100%;border-collapse:separate;border-spacing:0}
table.inst th, table.inst td{padding:6px 6px;border-bottom:1px dashed var(--line);font-size:12px;text-align:left}
table.inst thead th{position:sticky;top:0;background:#0e1630;border-bottom:1px solid var(--line)}
.del{cursor:pointer;color:#ff8d8d;font-weight:800}
.switch{display:flex;gap:6px;align-items:center}

/* Chart & legend */
.chart-box{padding:8px 12px}
canvas{width:100%;height:420px !important}
.legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:var(--muted);margin-top:6px}
.sw{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px}

/* Tabela anual */
.table-wrap{overflow:auto;max-height:460px;border-top:1px solid var(--line)}
table.annual{width:100%;border-collapse:separate;border-spacing:0;min-width:1050px}
table.annual thead th{position:sticky;top:0;background:#0e1630;border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:12px}
table.annual tbody td{border-bottom:1px dashed var(--line);padding:8px;text-align:right}
table.annual tbody tr:nth-child(odd){background:#0c1531}
.left{text-align:left}
</style>
</head>
<body>
<header>
  <h1>Renda Fixa ‚Äî Cat√°logo + Simulador</h1>
  <div class="sub">Escolha t√≠tulos, veja descri√ß√£o/IR, simule com IPCA/CDI, metas, cortes, vencimentos e IR l√≠quido no fim. Linhas por t√≠tulo no gr√°fico. ‚ú®</div>
</header>

<div class="wrap">
  <!-- Painel esquerdo -->
  <section class="card">
    <h2>Par√¢metros & Cat√°logo</h2>
    <div class="content">
      <div class="grid g2">
        <div><label>Valor inicial (R$)<input type="number" id="valorInicial" value="10000" step="0.01" min="0"></label></div>
        <div><label>Aporte mensal base (R$)<input type="number" id="aporteMensal" value="800" step="0.01" min="0"></label></div>
        <div><label>Dura√ß√£o (anos)<input type="number" id="anos" value="20" min="1" step="1"></label></div>
        <div><label>Taxa de administra√ß√£o anual (%)<input type="number" id="taxaAdm" value="0.5" step="0.01" min="0"></label></div>
      </div>

      <div class="hr"></div>

      <h3 style="margin:4px 0 8px;font-size:14px">Infla√ß√£o (IPCA) & CDI</h3>
      <div class="grid g1">
        <div class="row" style="justify-content:space-between">
          <label style="flex:1">IPCA m√©dio (geom., 20 anos) (% a.a.)<input type="number" id="ipcaMedioInput" placeholder="Clique em Buscar IPCA" step="0.01"></label>
          <button class="btn" id="btnBuscarIPCA">üîé Buscar IPCA</button>
          <button class="btn ghost" id="btnUsar5">Usar 5% a.a.</button>
        </div>
        <div class="small" id="ipcaFonte"></div>
        <div class="grid g2">
          <div>
            <label>Modelo de proje√ß√£o</label>
            <select id="projModelo">
              <option value="const">Constante (usa IPCA m√©dio)</option>
              <option value="reversao">Revers√£o √† meta</option>
              <option value="custom">Personalizada (por ano)</option>
            </select>
          </div>
          <div class="row" id="boxReversao" style="display:none">
            <label style="flex:1">Meta IPCA (% a.a.)<input type="number" id="projMeta" value="3" step="0.1"></label>
            <label style="flex:1">Horizonte (anos)<input type="number" id="projHorizonte" value="5" min="1" step="1"></label>
          </div>
        </div>
        <div id="boxCustom" style="display:none">
          <label>IPCA por ano (% a.a.; a partir do Ano 2)</label>
          <textarea id="projLista" rows="3" placeholder="Ex.: 5;4.8;4.5;4.2;4;3.8"></textarea>
        </div>
        <div class="grid g2" style="margin-top:6px">
          <div><label>CDI anual (% a.a.)<input type="number" id="cdiAnual" value="12.0" step="0.01"></label></div>
          <div class="small" style="display:flex;align-items:end">Usado em t√≠tulos ‚Äú% do CDI‚Äù.</div>
        </div>
      </div>

      <div class="hr"></div>

      <h3 style="margin:4px 0 8px;font-size:14px">Cat√°logo de t√≠tulos</h3>
      <div class="search">
        <input type="text" id="catSearch" placeholder="Buscar: CDB, LCI, Tesouro IPCA+, deb√™nture..." />
        <button class="btn ghost" id="btnLimparBusca">Limpar</button>
      </div>
      <div class="cat-list" id="catList"></div>
      <div class="small" id="catDesc" style="margin-top:8px;line-height:1.4"></div>

      <div class="hr"></div>

      <h3 style="margin:4px 0 8px;font-size:14px">Cortes & Metas</h3>
      <div class="grid g3">
        <div><label>Ano do corte<input type="number" id="corteAno" min="1" step="1" placeholder="ex.: 5"></label></div>
        <div><label>Novo aporte base (R$)<input type="number" id="corteAporte" step="0.01" placeholder="opcional"></label></div>
        <div><label>Nota<input type="text" id="corteNota" placeholder="ex.: promo√ß√£o, b√¥nus"></label></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn alt" id="btnAddCorte">+ Adicionar corte</button>
        <button class="btn ghost" id="btnLimparCortes">Limpar cortes</button>
      </div>
      <div class="row" id="cortesChips" style="margin-top:8px"></div>

      <div class="grid g3" style="margin-top:10px">
        <div><label>Ano da meta<input type="number" id="metaAno" min="1" step="1" placeholder="ex.: 10"></label></div>
        <div><label>Valor alvo (R$)<input type="number" id="metaValor" step="0.01" placeholder="ex.: 500000"></label></div>
        <div class="row" style="align-items:end">
          <button class="btn alt" id="btnAddMeta">+ Meta</button>
          <button class="btn ghost" id="btnLimparMetas">Limpar</button>
        </div>
      </div>
      <div class="row" id="metasChips" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Painel direito -->
  <section class="card">
    <div class="content">
      <h2>Carteira & Simula√ß√£o</h2>

      <div class="kpis">
        <div class="kpi"><div class="l">Total investido</div><div class="v" id="kpiInvestido">R$ 0,00</div><div class="s">Inicial + aportes</div></div>
        <div class="kpi"><div class="l">Juros l√≠quidos</div><div class="v" id="kpiJuros">R$ 0,00</div><div class="s">Ap√≥s IR/cust√≥dia/adm</div></div>
        <div class="kpi"><div class="l">Saldo final (nominal)</div><div class="v" id="kpiSaldo">R$ 0,00</div><div class="s">Ao fim do per√≠odo</div></div>
      </div>

      <div class="hr"></div>

      <h3 style="margin:4px 0 8px;font-size:14px">Instrumentos da carteira</h3>
      <table class="inst" id="instTable">
        <thead>
          <tr>
            <th>Tipo</th><th>Indexador</th><th>Par√¢metro</th><th>Venc. (anos)</th><th>Aloc. (%)</th>
            <th>Cust√≥dia (% a.a.)</th><th>Reinv.</th><th>Gr√°fico?</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:6px">
        <button class="btn alt" id="btnAddInst">+ Adicionar t√≠tulo</button>
        <button class="btn ghost" id="btnExemplo">Exemplo (CDB 100%)</button>
      </div>
      <div class="small" id="alocMsg"></div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="btnCalcular">‚ñ∂Ô∏è Calcular</button>
        <button class="btn ghost" id="btnCSV">‚§ì CSV</button>
        <button class="btn ghost" id="btnPNG">‚§ì PNG</button>
      </div>
    </div>

    <div class="chart-box">
      <canvas id="chart"></canvas>
      <div class="legend">
        <span><span class="sw" style="background:var(--blue)"></span>Investido</span>
        <span><span class="sw" style="background:var(--orange)"></span>Saldo nominal</span>
        <span><span class="sw" style="background:var(--green)"></span>Saldo real</span>
        <span><span class="sw" style="background:var(--violet)"></span>Linhas por t√≠tulo selecionadas</span>
      </div>
    </div>

    <div class="table-wrap">
      <table class="annual" id="tbl">
        <thead>
          <tr>
            <th class="left">Ano</th>
            <th>Saldo in√≠cio</th>
            <th>Aporte do ano</th>
            <th>Juros ano (l√≠q.)</th>
            <th>IR</th>
            <th>Cust√≥dia</th>
            <th>Taxa Adm</th>
            <th>Saldo final</th>
            <th>Saldo (R$ de hoje)</th>
            <th>Aporte base</th>
            <th>IPCA do ano</th>
            <th>Corte?</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* ===================== Utils ===================== */
const brl = v => (v??0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const toNum = el => parseFloat(String(el.value).replace(',','.'))||0;
function q(s){return document.querySelector(s)}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}

/* ===================== Elements ===================== */
const E = {
  valorInicial:q('#valorInicial'), aporteMensal:q('#aporteMensal'), anos:q('#anos'),
  taxaAdm:q('#taxaAdm'), cdiAnual:q('#cdiAnual'),
  ipcaMedioInput:q('#ipcaMedioInput'), btnBuscarIPCA:q('#btnBuscarIPCA'), btnUsar5:q('#btnUsar5'), ipcaFonte:q('#ipcaFonte'),
  projModelo:q('#projModelo'), projMeta:q('#projMeta'), projHorizonte:q('#projHorizonte'), projLista:q('#projLista'),
  boxReversao:q('#boxReversao'), boxCustom:q('#boxCustom'),
  // cat√°logo
  catSearch:q('#catSearch'), btnLimparBusca:q('#btnLimparBusca'), catList:q('#catList'), catDesc:q('#catDesc'),
  // cortes/metas
  corteAno:q('#corteAno'), corteAporte:q('#corteAporte'), corteNota:q('#corteNota'),
  btnAddCorte:q('#btnAddCorte'), btnLimparCortes:q('#btnLimparCortes'), cortesChips:q('#cortesChips'),
  metaAno:q('#metaAno'), metaValor:q('#metaValor'), btnAddMeta:q('#btnAddMeta'), btnLimparMetas:q('#btnLimparMetas'), metasChips:q('#metasChips'),
  // instrumentos
  instTable:q('#instTable tbody'), btnAddInst:q('#btnAddInst'), btnExemplo:q('#btnExemplo'), alocMsg:q('#alocMsg'),
  // a√ß√µes
  btnCalcular:q('#btnCalcular'), btnCSV:q('#btnCSV'), btnPNG:q('#btnPNG'),
  // KPIs
  kpiInvestido:q('#kpiInvestido'), kpiJuros:q('#kpiJuros'), kpiSaldo:q('#kpiSaldo'),
  // chart & table
  chartEl:q('#chart'), tblBody:q('#tbl tbody'),
};

/* ===================== Cat√°logo de t√≠tulos ===================== */
/* regime:
   - 'regressivo' -> IR pela tabela 22,5/20/17,5/15 no vencimento
   - 'isento'     -> isento p/ PF
   - 'nenhum'     -> sem IR (ex.: Poupan√ßa)
   indexadores: ['prefixado','ipca+','cdi%']
*/
const CATALOG = [
  {code:'CDB', nome:'CDB (Banco)', regime:'regressivo', indexadores:['prefixado','ipca+','cdi%'],
   desc:'T√≠tulo banc√°rio. Pode pagar prefixado, IPCA+spread ou % do CDI. Cobertura FGC at√© limites vigentes. IR regressivo no vencimento.'},
  {code:'RDB', nome:'RDB', regime:'regressivo', indexadores:['prefixado','ipca+','cdi%'],
   desc:'Recibo de Dep√≥sito Banc√°rio. Similar ao CDB em risco e tributa√ß√£o (IR regressivo).'},
  {code:'LC', nome:'Letra de C√¢mbio (LC)', regime:'regressivo', indexadores:['prefixado','cdi%'],
   desc:'Emitida por financeiras. IR regressivo. Normalmente indexada a % do CDI.'},
  {code:'LF', nome:'Letra Financeira (LF)', regime:'regressivo', indexadores:['prefixado','cdi%'],
   desc:'Prazo mais longo, pode ter car√™ncia. IR regressivo.'},
  {code:'LCI', nome:'LCI', regime:'isento', indexadores:['prefixado','ipca+','cdi%'],
   desc:'Letra de Cr√©dito Imobili√°rio. Isenta de IR p/ pessoa f√≠sica. Cobertura FGC, prazos m√≠nimos.'},
  {code:'LCA', nome:'LCA', regime:'isento', indexadores:['prefixado','ipca+','cdi%'],
   desc:'Letra de Cr√©dito do Agroneg√≥cio. Isenta de IR p/ PF. Cobertura FGC, prazos m√≠nimos.'},
  {code:'CRI', nome:'CRI', regime:'isento', indexadores:['prefixado','ipca%','ipca+'],
   desc:'Certificado de Receb√≠veis Imobili√°rios. Em geral isento p/ PF, sem FGC. Risco de cr√©dito da opera√ß√£o.'},
  {code:'CRA', nome:'CRA', regime:'isento', indexadores:['prefixado','ipca+'],
   desc:'Certificado de Receb√≠veis do Agroneg√≥cio. Em geral isento p/ PF, sem FGC. Risco do emissor/estrutura.'},
  {code:'DEB', nome:'Deb√™nture (comum)', regime:'regressivo', indexadores:['prefixado','ipca+','cdi%'],
   desc:'D√≠vida de empresas. Tributada (IR regressivo) para PF. Sem FGC.'},
  {code:'DEBINC', nome:'Deb√™nture Incentivada', regime:'isento', indexadores:['prefixado','ipca+','cdi%'],
   desc:'Deb√™nture com isen√ß√£o de IR p/ PF (infraestrutura). Sem FGC.'},
  {code:'TESSEL', nome:'Tesouro Selic', regime:'regressivo', indexadores:['cdi%'],
   desc:'T√≠tulo p√∫blico p√≥s-fixado pr√≥ximo √† Selic/CDI. IR regressivo. Pode ter taxa de cust√≥dia.'},
  {code:'TESPRE', nome:'Tesouro Prefixado', regime:'regressivo', indexadores:['prefixado'],
   desc:'T√≠tulo p√∫blico prefixado. IR regressivo. Pode ter taxa de cust√≥dia.'},
  {code:'TESIPCA', nome:'Tesouro IPCA+', regime:'regressivo', indexadores:['ipca+'],
   desc:'T√≠tulo p√∫blico indexado ao IPCA + juros reais. IR regressivo. Pode ter taxa de cust√≥dia.'},
  {code:'POUP', nome:'Poupan√ßa', regime:'isento', indexadores:['prefixado'],
   desc:'Poupan√ßa (simulada como taxa efetiva anual). Isenta de IR. Regras reais podem variar; aqui simplificamos.'},
];

const COLORS = ['#5ea0ff','#ff9f43','#46d39a','#a38bff','#ffd166','#ef476f','#26b6bd','#c084fc','#22d3ee','#7dd3fc','#f472b6','#f97316'];

/* ===================== Estado ===================== */
let chart;
let cortes=[]; // {ano, novoAporte?, nota?}
let metas=[];  // {ano, valor}
let instId = 0;

/* ===================== IPCA (SGS 433) ===================== */
async function buscarIPCAGeometrico20Anos(){
  const url='https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados?formato=json';
  const r = await fetch(url,{cache:'no-store'});
  if(!r.ok) throw new Error('Falha ao buscar IPCA');
  const all = await r.json();
  if(!Array.isArray(all) || all.length<240) throw new Error('S√©rie insuficiente');
  const last240 = all.slice(-240);
  const monthly = last240.map(d => parseFloat(String(d.valor).replace(',','.'))/100);
  const product = monthly.reduce((a,x)=>a*(1+x),1);
  const annual = Math.pow(product,12/monthly.length)-1;
  return {annual, inicio:last240[0]?.data, fim:last240.at(-1)?.data};
}

/* ===================== Proje√ß√£o IPCA por ano ===================== */
function montarIPCAAnual(anos, ipcaMedio){
  const modelo = E.projModelo.value;
  const out = new Array(anos).fill(ipcaMedio);
  if(modelo==='reversao'){
    const meta = Math.max(-0.99, toNum(E.projMeta)/100);
    const H = Math.max(1, Math.floor(toNum(E.projHorizonte)));
    for(let a=2;a<=anos;a++){
      const t = Math.min(1,(a-2)/(H-1||1));
      out[a-1] = ipcaMedio*(1-t) + meta*t;
    }
  }else if(modelo==='custom'){
    const raw = E.projLista.value.split(';').map(s=>parseFloat(s.replace(',','.'))/100).filter(x=>!Number.isNaN(x));
    for(let i=0;i<raw.length && (i+1)<anos;i++) out[i+1]=raw[i];
  }
  return out; // out[a-1] = IPCA do ano a
}

/* ===================== UI: cat√°logo ===================== */
function renderCatalog(filter=''){
  const f = filter.trim().toLowerCase();
  E.catList.innerHTML='';
  CATALOG.filter(c => c.nome.toLowerCase().includes(f) || c.code.toLowerCase().includes(f))
    .forEach((c,i)=>{
      const div=document.createElement('div');
      div.className='cat-item';
      div.innerHTML = `<b>${c.nome}</b> <span class="badge">${c.regime==='isento'?'Isento':'IR regressivo'}</span> <span class="badge">Indexadores: ${c.indexadores.join(', ')}</span>`;
      div.addEventListener('click',()=> selectCatalog(c));
      E.catList.appendChild(div);
    });
}
function selectCatalog(c){
  E.catDesc.innerHTML = `<b>${c.nome}</b><br>${c.desc}<br><span class="badge">${c.regime==='isento'?'Isento de IR (PF)':'IR tabela regressiva no vencimento'}</span> ‚Ä¢ Indexadores: <i>${c.indexadores.join(', ')}</i>`;
  // prefills instrument row
  addInstRow({
    tipo:c.code,
    indexador:c.indexadores[0],
    param: c.indexadores[0]==='cdi%'? 100 : (c.indexadores[0]==='ipca+'? 6 : 12),
    vcto: 2,
    aloc: 50,
    custodia: (c.code.startsWith('TES')?0.2:0),
    reinv:true,
    show:true
  });
}

/* ===================== UI: instrumentos ===================== */
function addInstRow(data={}){
  const tr=document.createElement('tr');
  const id=++instId;
  const tipoOpt = (sel)=> CATALOG.map(c=>`<option value="${c.code}" ${sel===c.code?'selected':''}>${c.nome}</option>`).join('');
  const idxOpts = (sel)=> ['prefixado','ipca+','cdi%'].map(k=>`<option ${sel===k?'selected':''}>${k}</option>`).join('');
  tr.dataset.id = id;
  tr.innerHTML = `
    <td><select class="tipo">${tipoOpt(data.tipo||'CDB')}</select></td>
    <td><select class="indexador">${idxOpts(data.indexador||'cdi%')}</select></td>
    <td><input type="number" class="param" step="0.01" value="${data.param??100}" title="Prefixado: % a.a. ‚Ä¢ IPCA+: spread % a.a. ‚Ä¢ CDI%: percentual do CDI"></td>
    <td><input type="number" class="vcto" step="0.1" value="${data.vcto??2}"></td>
    <td><input type="number" class="aloc" step="0.01" value="${data.aloc??100}"></td>
    <td><input type="number" class="custodia" step="0.01" value="${data.custodia??0}"></td>
    <td class="switch"><input type="checkbox" class="reinv" ${data.reinv===false?'':'checked'}> sim</td>
    <td class="switch"><input type="checkbox" class="show" ${data.show===false?'':'checked'}> sim</td>
    <td><span class="del" title="remover">√ó</span></td>
  `;
  // limitar indexadores conforme o tipo
  const tipoSel = tr.querySelector('.tipo');
  const idxSel = tr.querySelector('.indexador');
  function syncIndexadores(){
    const item = CATALOG.find(x=>x.code===tipoSel.value);
    const allowed = item.indexadores;
    Array.from(idxSel.options).forEach(op=> op.disabled = !allowed.includes(op.value));
    if(!allowed.includes(idxSel.value)) idxSel.value = allowed[0];
  }
  tipoSel.addEventListener('change', syncIndexadores);
  syncIndexadores();

  tr.querySelector('.del').addEventListener('click',()=>{ tr.remove(); validarAlocacao(); });
  ['input','change'].forEach(evt => tr.addEventListener(evt, validarAlocacao));
  E.instTable.appendChild(tr);
  validarAlocacao();
}
function readInstRows(){
  return Array.from(E.instTable.querySelectorAll('tr')).map(tr=>{
    const tipo = tr.querySelector('.tipo').value;
    const indexador = tr.querySelector('.indexador').value;
    const param = parseFloat(tr.querySelector('.param').value)||0; // prefixado: taxa; ipca+: spread; cdi%: %
    const vcto = parseFloat(tr.querySelector('.vcto').value)||1;
    const aloc = parseFloat(tr.querySelector('.aloc').value)||0;
    const custodia = parseFloat(tr.querySelector('.custodia').value)||0; // a.a.
    const reinv = tr.querySelector('.reinv').checked;
    const show = tr.querySelector('.show').checked;
    return {tipo,indexador,param,vcto,aloc,custodia,reinv,show};
  });
}
function validarAlocacao(){
  const inst = readInstRows();
  const total = inst.reduce((s,i)=>s+(i.aloc||0),0);
  let msg = `Aloca√ß√£o total: ${total.toFixed(2)}%`;
  msg += total>100 ? ' ‚Ä¢ ‚ö†Ô∏è acima de 100% ‚Äî ajuste!'
       : total<100 ? ' ‚Ä¢ restante vai para Caixa (0% nominal)' : '';
  E.alocMsg.textContent = msg;
}

/* ===================== Cortes & Metas ===================== */
function renderChips(container, list, labelFn, onDel){
  container.innerHTML='';
  if(!list.length){ const p=document.createElement('div'); p.className='small'; p.textContent='Nenhum item.'; container.appendChild(p); return; }
  list.forEach((x,i)=>{
    const span=document.createElement('span');
    span.className='small';
    span.style.cssText='display:inline-flex;gap:8px;align-items:center;background:#0e1630;border:1px dashed var(--line);padding:6px 10px;border-radius:999px;margin:4px';
    span.innerHTML = `${labelFn(x)} <span class="del" data-i="${i}" style="cursor:pointer;color:#ff8d8d;font-weight:800">√ó</span>`;
    container.appendChild(span);
  });
  container.querySelectorAll('.del').forEach(d=> d.addEventListener('click', e=>{ const i=Number(e.target.dataset.i); onDel(i); }));
}
function renderCortes(){ renderChips(E.cortesChips, cortes, c=>`Ano ${c.ano} ‚Ä¢ Aporte ${c.novoAporte?brl(c.novoAporte):'‚Äî'}${c.nota?` ‚Ä¢ ${c.nota}`:''}`, i=>{cortes.splice(i,1); renderCortes();}); }
function renderMetas(){ renderChips(E.metasChips, metas, m=>`Meta ano ${m.ano}: ${brl(m.valor)}`, i=>{metas.splice(i,1); renderMetas();}); }

/* ===================== IR & taxas ===================== */
function irRegressivoAliquota(prazoMeses){
  const d = prazoMeses*30; // aprox.
  if(d<=180) return 0.225;
  if(d<=360) return 0.20;
  if(d<=720) return 0.175;
  return 0.15;
}
function regimeIR(tipoCode){
  const item = CATALOG.find(x=>x.code===tipoCode);
  return item?.regime || 'regressivo';
}

/* ===================== Simulador ===================== */
function simular(){
  const anos = Math.max(1, Math.floor(toNum(E.anos)));
  const meses = anos*12;
  const aporteMensalBaseIni = toNum(E.aporteMensal);
  const taxaAdmAnual = Math.max(0, toNum(E.taxaAdm)/100);
  const taxaAdmMensal = taxaAdmAnual/12;
  const ipcaMedio = (parseFloat(E.ipcaMedioInput.value?.replace(',','.'))||0)/100;
  const ipcaPorAno = montarIPCAAnual(anos, ipcaMedio);
  const cdiAnual = Math.max(0, toNum(E.cdiAnual)/100);

  const inst = readInstRows();
  const alocTotal = inst.reduce((s,i)=>s+(i.aloc||0),0);
  const frac = inst.map((i,k)=>({...i, frac:(i.aloc||0)/100, color: COLORS[k%COLORS.length]}));
  const caixaFrac = Math.max(0, 1 - alocTotal/100);

  // Carteira din√¢mica
  let saldoCaixa = toNum(E.valorInicial);
  let investidoAportes = 0;
  let aporteBaseAno = aporteMensalBaseIni;

  const lotes = []; // {key, tipo, indexador, param, principal, principalIni, mesesRest, prazoMeses, custodiaMensal, reinv}
  const maturedEvents = []; // {anoIdx, tipoNome, bruto, ir, liquido}

  // agregadores
  const rowsAno=[]; const labels=[]; const serieInvestido=[]; const serieSaldoNominal=[]; const serieSaldoReal=[];
  const seriesPorTitulo = new Map(); // code -> [anos] soma nominal
  frac.forEach(i=> seriesPorTitulo.set(i.tipo, []));

  let jurosAno=0, irAno=0, admAno=0, custodiaAno=0;

  function taxaMensalDoLote(l, anoIdx){
    // retorna taxa mensal efetiva conforme indexador
    let annual;
    if(l.indexador==='prefixado'){
      annual = l.param/100;
    }else if(l.indexador==='ipca+'){
      const ipcaA = ipcaPorAno[anoIdx]||0;
      annual = (1+ipcaA)*(1 + (l.param/100)) - 1;
    }else{ // cdi%
      annual = (cdiAnual) * (l.param/100); // param = 100 => 100% do CDI
    }
    return Math.pow(1+annual,1/12)-1;
  }
  function aplicarTaxaAdm(totalAntes){
    if(totalAntes<=0 || taxaAdmMensal<=0) return 0;
    const custo = totalAntes * taxaAdmMensal;
    const fator = 1 - taxaAdmMensal;
    saldoCaixa *= fator;
    lotes.forEach(l=> l.principal *= fator);
    return custo;
  }

  for(let m=0;m<meses;m++){
    const anoAtual = Math.floor(m/12)+1;
    const mesNoAno = (m%12)+1;
    const anoIdx = anoAtual-1;

    // in√≠cio do ano: cortes e reajuste do aporte pelo IPCA do ano anterior
    if(mesNoAno===1){
      const corte = cortes.find(c=>c.ano===anoAtual);
      if(corte && typeof corte.novoAporte==='number') aporteBaseAno = corte.novoAporte;
      else if(anoAtual>1) aporteBaseAno = aporteBaseAno * (1 + ipcaPorAno[anoIdx-1]);

      if(!rowsAno[anoIdx]) rowsAno[anoIdx] = {ano:anoAtual, saldoInicio: saldoCaixa + lotes.reduce((s,l)=>s+l.principal,0), aporteAno:0, jurosAno:0, irAno:0, custodiaAno:0, admAno:0, saldoFim:null, aporteBaseAno, ipcaAno: ipcaPorAno[anoIdx], corte: corte? (corte.nota?('Sim ‚Äî '+corte.nota):'Sim') : ''};
    }

    // aporte do m√™s
    const aporteMes = aporteBaseAno;
    investidoAportes += aporteMes;
    rowsAno[anoIdx].aporteAno += aporteMes;

    // distribuir
    const paraCaixa = aporteMes * caixaFrac;
    saldoCaixa += paraCaixa;

    frac.forEach(i=>{
      const v = aporteMes * i.frac;
      if(v<=0) return;
      const prazoMeses = Math.max(1, Math.round(i.vcto*12));
      lotes.push({
        key:i.tipo, tipo:i.tipo, indexador:i.indexador, param:i.param,
        principal:v, principalIni:v, mesesRest:prazoMeses, prazoMeses:prazoMeses,
        custodiaMensal:(i.custodia||0)/100/12, reinv: !!i.reinv, color:i.color
      });
    });

    // render mensal dos lotes
    for(const l of lotes){
      const r = taxaMensalDoLote(l, anoIdx);
      const j = l.principal * r;
      l.principal += j;
      jurosAno += j;

      // cust√≥dia mensal por t√≠tulo (se houver)
      if(l.custodiaMensal>0){
        const custo = l.principal * l.custodiaMensal;
        l.principal -= custo;
        custodiaAno += custo;
      }
      l.mesesRest -= 1;
    }

    // maturidade: IR conforme regime
    for(let i=lotes.length-1;i>=0;i--){
      const l = lotes[i];
      if(l.mesesRest<=0){
        const ganho = Math.max(0, l.principal - l.principalIni);
        let ir=0;
        const reg = regimeIR(l.tipo);
        if(reg==='regressivo'){
          const aliq = irRegressivoAliquota(l.prazoMeses);
          ir = ganho * aliq;
        }else if(reg==='isento'){
          ir = 0;
        }
        irAno += ir;
        const liquido = l.principal - ir;
        maturedEvents.push({anoIdx, tipoNome: CATALOG.find(x=>x.code===l.tipo)?.nome || l.tipo, bruto:l.principal, ir, liquido, color:l.color});
        if(l.reinv){
          l.principal = liquido; l.principalIni = liquido; l.mesesRest = l.prazoMeses;
        }else{
          saldoCaixa += liquido;
          lotes.splice(i,1);
        }
      }
    }

    // taxa de administra√ß√£o mensal sobre total (caixa + lotes)
    const totalAntes = saldoCaixa + lotes.reduce((s,l)=>s+l.principal,0);
    const custoAdm = aplicarTaxaAdm(totalAntes);
    if(custoAdm>0) { admAno += custoAdm; }

    if(mesNoAno===12){
      const total = saldoCaixa + lotes.reduce((s,l)=>s+l.principal,0);
      rowsAno[anoIdx].jurosAno += (jurosAno - irAno - custodiaAno - admAno);
      rowsAno[anoIdx].irAno += irAno;
      rowsAno[anoIdx].custodiaAno += custodiaAno;
      rowsAno[anoIdx].admAno += admAno;
      rowsAno[anoIdx].saldoFim = total;

      labels.push(`Ano ${anoAtual}`);
      const investidoAteAqui = toNum(E.valorInicial) + investidoAportes;
      serieInvestido.push(investidoAteAqui);
      serieSaldoNominal.push(total);
      const infl = ipcaPorAno.slice(0, anoAtual).reduce((acc,x)=>acc*(1+x),1);
      serieSaldoReal.push(total / infl);

      // s√©rie por t√≠tulo (somat√≥rio nominal)
      const sumPorTitulo = {};
      for(const l of lotes){ sumPorTitulo[l.key] = (sumPorTitulo[l.key]||0) + l.principal; }
      for(const i of frac){
        const arr = seriesPorTitulo.get(i.tipo);
        arr[anoIdx] = sumPorTitulo[i.tipo]||0;
      }

      // reset agregadores anuais
      jurosAno=0; irAno=0; admAno=0; custodiaAno=0;
    }
  }

  // KPIs
  const investidoTotal = toNum(E.valorInicial) + investidoAportes;
  const saldoFinal = serieSaldoNominal.at(-1) || 0;
  const jurosLiquidos = Math.max(0, saldoFinal - investidoTotal);
  E.kpiInvestido.textContent = brl(investidoTotal);
  E.kpiSaldo.textContent = brl(saldoFinal);
  E.kpiJuros.textContent = brl(jurosLiquidos);

  // Tabela
  renderTabela(rowsAno, serieSaldoReal);

  // Gr√°fico
  renderGrafico(labels, serieInvestido, serieSaldoNominal, serieSaldoReal, seriesPorTitulo, maturedEvents, rowsAno);
}

/* ===================== Tabela anual ===================== */
function renderTabela(rows, serieSaldoReal){
  E.tblBody.innerHTML='';
  const frag=document.createDocumentFragment();
  rows.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="left">${r.ano}</td>
      <td>${brl(r.saldoInicio)}</td>
      <td>${brl(r.aporteAno)}</td>
      <td>${brl(r.jurosAno)}</td>
      <td>${brl(r.irAno)}</td>
      <td>${brl(r.custodiaAno)}</td>
      <td>${brl(r.admAno)}</td>
      <td>${brl(r.saldoFim)}</td>
      <td>${brl(serieSaldoReal[idx]||0)}</td>
      <td>${brl(r.aporteBaseAno)}</td>
      <td>${((r.ipcaAno||0)*100).toFixed(2)}%</td>
      <td>${r.corte||''}</td>
    `;
    frag.appendChild(tr);
  });
  E.tblBody.appendChild(frag);
}

/* ===================== Gr√°fico ===================== */
function renderGrafico(labels, investido, saldoNom, saldoReal, seriesPorTitulo, maturedEvents, rows){
  if(chart) chart.destroy();
  Chart.register(window['chartjs-plugin-annotation']);

  // datasets principais
  const datasets = [
    {label:'Investido', data:investido, borderColor:'var(--blue)', backgroundColor:'transparent', tension:.25, borderWidth:2},
    {label:'Saldo nominal', data:saldoNom, borderColor:'var(--orange)', backgroundColor:'transparent', tension:.22, borderWidth:2},
    {label:'Saldo real (R$ de hoje)', data:saldoReal, borderColor:'var(--green)', backgroundColor:'transparent', tension:.22, borderWidth:2}
  ];

  // s√©ries por t√≠tulo selecionados
  const inst = readInstRows();
  inst.forEach((i,idx)=>{
    if(!i.show) return;
    const arr = seriesPorTitulo.get(i.tipo) || [];
    datasets.push({
      label: CATALOG.find(x=>x.code===i.tipo)?.nome || i.tipo,
      data: arr, borderColor: COLORS[idx%COLORS.length], backgroundColor:'transparent', borderWidth:1.5, tension:.18
    });
  });

  // anota√ß√µes: cortes (verticais) e metas (horizontais)
  const annotations = {};
  rows.forEach((r,idx)=>{ if(r.corte){ annotations['corte_'+idx] = {type:'line', xMin:idx, xMax:idx, borderColor:'#ffd166', borderWidth:2, borderDash:[6,6], label:{enabled:true, content:`Corte ${r.ano}`, position:'start', backgroundColor:'#0e1630', color:'#ffd166'}}; } });
  metas.forEach((m,i)=>{ annotations['meta_'+i] = {type:'line', yMin:m.valor, yMax:m.valor, borderColor:'#26b6bd', borderWidth:2, label:{enabled:true, content:`Meta ${m.ano}: ${brl(m.valor)}`, position:'end', backgroundColor:'#0e1630', color:'#26b6bd'}}; });

  // ‚Äúmarcadores‚Äù de vencimento por ano: agregamos info para o tooltip
  const maturityByYear = new Map(); // idx -> [{nome,liq,ir,color}]
  maturedEvents.forEach(ev=>{
    const list = maturityByYear.get(ev.anoIdx) || [];
    list.push(ev); maturityByYear.set(ev.anoIdx, list);
  });
  // dataset de pontos (discretos) por vencimento
  const maturityPoints = [];
  labels.forEach((_,idx)=>{
    const list = maturityByYear.get(idx);
    if(!list) return;
    const y = (saldoNom[idx] || 0);
    maturityPoints.push({x:idx, y, meta:list});
  });
  if(maturityPoints.length){
    datasets.push({
      type:'scatter',
      label:'Vencimentos (l√≠quido/IR)',
      data: maturityPoints,
      borderColor:'#ffffff', backgroundColor:'#ffffff', pointRadius:4, pointHoverRadius:6, showLine:false
    });
  }

  chart = new Chart(E.chartEl, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'nearest',intersect:false},
      scales:{
        y:{beginAtZero:true, ticks:{color:'#cfe4ff', callback:v=>brl(v)}, grid:{color:'rgba(255,255,255,.06)'}},
        x:{ticks:{color:'#cfe4ff'}, grid:{color:'rgba(255,255,255,.05)'}}
      },
      plugins:{
        legend:{labels:{color:'#dbe7ff', boxWidth:12}},
        tooltip:{
          callbacks:{
            label: ctx => {
              if(ctx.dataset.label==='Vencimentos (l√≠quido/IR)'){
                const meta = ctx.raw.meta;
                const lines = meta.map(m=>`${m.tipoNome}: L√≠q ${brl(m.liquido)} ‚Ä¢ IR ${brl(m.ir)}`);
                return lines;
              }
              return `${ctx.dataset.label}: ${brl(ctx.parsed.y)}`;
            }
          }
        },
        annotation:{annotations}
      }
    }
  });
}

/* ===================== CSV & PNG ===================== */
function baixarCSV(){
  const rows=[['Ano','SaldoInicio','AporteAno','JurosAnoLiquido','IR','Custodia','TaxaAdm','SaldoFinal','SaldoReal','AporteBaseAno','IPCAAno','Corte']];
  E.tblBody.querySelectorAll('tr').forEach(tr=>{
    const cols=Array.from(tr.children).map(td=>td.innerText.replace(/\./g,'').replace('R$ ','').replace(',','.'));
    rows.push(cols);
  });
  const csv=rows.map(r=>r.join(';')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='simulacao_anual.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function baixarPNG(){
  const a=document.createElement('a');
  a.href=E.chartEl.toDataURL('image/png',1.0);
  a.download='grafico.png'; a.click();
}

/* ===================== Eventos ===================== */
E.btnBuscarIPCA.addEventListener('click', async ()=>{
  try{
    E.btnBuscarIPCA.disabled=true; E.btnBuscarIPCA.textContent='Buscando...';
    const {annual,inicio,fim}=await buscarIPCAGeometrico20Anos();
    E.ipcaMedioInput.value=(annual*100).toFixed(2);
    E.ipcaFonte.innerHTML=`IPCA m√©dio (geom., 20 anos): <b>${(annual*100).toFixed(2)}% a.a.</b> ‚Ä¢ Per√≠odo ${inicio}‚Äì${fim}`;
  }catch(e){ alert('N√£o consegui buscar o IPCA agora. Insira manualmente.'); }
  finally{ E.btnBuscarIPCA.disabled=false; E.btnBuscarIPCA.textContent='üîé Buscar IPCA'; }
});
E.btnUsar5.addEventListener('click',()=>{ E.ipcaMedioInput.value='5.00'; E.ipcaFonte.textContent='IPCA m√©dio definido: 5,00% a.a.'; });

E.projModelo.addEventListener('change', ()=>{
  const v=E.projModelo.value;
  E.boxReversao.style.display = v==='reversao' ? 'flex' : 'none';
  E.boxCustom.style.display   = v==='custom'   ? 'block' : 'none';
});

E.btnAddCorte.addEventListener('click',()=>{
  const ano=Math.max(1,Math.floor(toNum(E.corteAno)));
  if(!ano){ alert('Informe o ano do corte'); return; }
  const novoAporte = E.corteAporte.value===''?undefined:parseFloat(E.corteAporte.value.replace(',','.'));
  const nota = E.corteNota.value?.trim() || '';
  const i=cortes.findIndex(c=>c.ano===ano);
  const novo={ano, ...(novoAporte!==undefined?{novoAporte}:{}) , ...(nota?{nota}:{})};
  if(i>=0) cortes[i]=novo; else cortes.push(novo);
  E.corteAno.value=''; E.corteAporte.value=''; E.corteNota.value='';
  renderCortes();
});
E.btnLimparCortes.addEventListener('click',()=>{ cortes=[]; renderCortes(); });

E.btnAddMeta.addEventListener('click',()=>{
  const ano=Math.max(1,Math.floor(toNum(E.metaAno)));
  const valor=parseFloat(E.metaValor.value?.replace(',','.'));
  if(!ano || Number.isNaN(valor)){ alert('Informe ano e valor'); return; }
  metas.push({ano,valor}); metas.sort((a,b)=>a.valor-b.valor); E.metaAno.value=''; E.metaValor.value=''; renderMetas();
});
E.btnLimparMetas.addEventListener('click',()=>{ metas=[]; renderMetas(); });

E.btnAddInst.addEventListener('click',()=> addInstRow({}));
E.btnExemplo.addEventListener('click',()=>{
  E.instTable.innerHTML=''; addInstRow({tipo:'CDB', indexador:'cdi%', param:110, vcto:2, aloc:100, custodia:0, reinv:true, show:true});
});
E.btnCalcular.addEventListener('click',()=> simular());
E.btnCSV.addEventListener('click',()=> baixarCSV());
E.btnPNG.addEventListener('click',()=> baixarPNG());

E.catSearch.addEventListener('input',()=> renderCatalog(E.catSearch.value));
E.btnLimparBusca.addEventListener('click',()=>{ E.catSearch.value=''; renderCatalog(''); });

/* ===================== Inicial ===================== */
renderCatalog('');
addInstRow({tipo:'CDB', indexador:'cdi%', param:110, vcto:2, aloc:100, custodia:0, reinv:true, show:true});
renderCortes(); renderMetas();
simular();
</script>
</body>
</html>
